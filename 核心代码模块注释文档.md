# Stable Diffusion WebUI æ ¸å¿ƒä»£ç æ¨¡å—æ³¨é‡Šæ–‡æ¡£

**é¡¹ç›®æ ¹ç›®å½•**: `e:\å¤§ä¸‰ä¸Š\è½¯ä»¶å·¥ç¨‹\æœŸæœ«å¤§ä½œä¸š\stable-diffusion-webui`

---

## ç›®å½•
1. [é¡¹ç›®æ¶æ„æ¦‚è¿°](#1-é¡¹ç›®æ¶æ„æ¦‚è¿°)
2. [å¯åŠ¨æ¨¡å—](#2-å¯åŠ¨æ¨¡å—)
3. [å›¾åƒå¤„ç†æ ¸å¿ƒ](#3-å›¾åƒå¤„ç†æ ¸å¿ƒ)
4. [æ¨¡å‹ç®¡ç†](#4-æ¨¡å‹ç®¡ç†)
5. [é‡‡æ ·å™¨ç®¡ç†](#5-é‡‡æ ·å™¨ç®¡ç†)
6. [APIæ¥å£](#6-apiæ¥å£)
7. [ç”¨æˆ·ç•Œé¢](#7-ç”¨æˆ·ç•Œé¢)
8. [è„šæœ¬ç³»ç»Ÿ](#8-è„šæœ¬ç³»ç»Ÿ)
9. [æ–‡ç”Ÿå›¾ä¸å›¾ç”Ÿå›¾](#9-æ–‡ç”Ÿå›¾ä¸å›¾ç”Ÿå›¾)
10. [å…±äº«é…ç½®](#10-å…±äº«é…ç½®)

---

## 1. é¡¹ç›®æ¶æ„æ¦‚è¿°

### æ•´ä½“æ¶æ„
```
å¯åŠ¨å±‚ (launch.py, webui.py)
    â†“
åˆå§‹åŒ–å±‚ (modules/initialize.py)
    â†“
ä¸šåŠ¡å±‚ (modules/processing.py, txt2img.py, img2img.py)
    â†“
æ¨¡å‹å±‚ (modules/sd_models.py, sd_samplers.py)
    â†“
è¡¨ç°å±‚ (modules/ui.py, modules/api/api.py)
```

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **Webæ¡†æ¶**: Gradio + FastAPI
- **æ·±åº¦å­¦ä¹ **: PyTorch + Stable Diffusion
- **å›¾åƒå¤„ç†**: PIL, OpenCV, NumPy
- **æ¨¡å‹æ ¼å¼**: SafeTensors, PyTorch Checkpoint

---

## 2. å¯åŠ¨æ¨¡å—

### 2.1 launch.py
**è·¯å¾„**: `launch.py`

**åŠŸèƒ½**: é¡¹ç›®ä¸»å…¥å£ï¼Œè´Ÿè´£ç¯å¢ƒå‡†å¤‡å’Œåº”ç”¨å¯åŠ¨

**æ ¸å¿ƒæµç¨‹**:
```python
def main():
    # 1. å¤„ç†ç³»ç»Ÿä¿¡æ¯å¯¼å‡º
    if args.dump_sysinfo:
        dump_sysinfo()
    
    # 2. å‡†å¤‡è¿è¡Œç¯å¢ƒï¼ˆå®‰è£…ä¾èµ–ï¼‰
    if not args.skip_prepare_environment:
        prepare_environment()
    
    # 3. å¯åŠ¨åº”ç”¨
    start()
```

**å…³é”®å‚æ•°**:
- `--skip-prepare-environment`: è·³è¿‡ç¯å¢ƒå‡†å¤‡
- `--dump-sysinfo`: å¯¼å‡ºç³»ç»Ÿä¿¡æ¯

---

### 2.2 webui.py
**è·¯å¾„**: `webui.py`

**åŠŸèƒ½**: Webåº”ç”¨ä¸»æ¨¡å—ï¼Œç®¡ç†UIå’ŒAPIæœåŠ¡

**ä¸»è¦å‡½æ•°**:

| å‡½æ•°å | åŠŸèƒ½ | è°ƒç”¨ä½ç½® |
|--------|------|----------|
| `create_api(app)` | åˆ›å»ºAPIå®ä¾‹ | webui() å†… |
| `api_only()` | ä»…å¯åŠ¨APIæ¨¡å¼ | å‘½ä»¤è¡Œ--nowebuiæ—¶ |
| `webui()` | å¯åŠ¨å®Œæ•´WebUI | é»˜è®¤å¯åŠ¨æ¨¡å¼ |

**å¯åŠ¨æµç¨‹**:
1. å¯¼å…¥æ¨¡å— â†’ 2. æ£€æŸ¥ç‰ˆæœ¬ â†’ 3. åˆå§‹åŒ– â†’ 4. åˆ›å»ºUI â†’ 5. å¯åŠ¨æœåŠ¡å™¨ â†’ 6. ç›‘å¬å‘½ä»¤ï¼ˆé‡å¯/åœæ­¢ï¼‰

---

## 3. å›¾åƒå¤„ç†æ ¸å¿ƒ

### 3.1 processing.py
**è·¯å¾„**: `modules/processing.py`

**åŠŸèƒ½**: å›¾åƒç”Ÿæˆçš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œæ˜¯æ•´ä¸ªé¡¹ç›®æœ€é‡è¦çš„æ¨¡å—

**æ ¸å¿ƒç±»**: `StableDiffusionProcessing`

```python
@dataclass
class StableDiffusionProcessing:
    # æç¤ºè¯
    prompt: str = ""
    negative_prompt: str = ""
    
    # å›¾åƒå‚æ•°
    width: int = 512
    height: int = 512
    batch_size: int = 1
    n_iter: int = 1
    
    # ç”Ÿæˆå‚æ•°
    steps: int = 50          # é‡‡æ ·æ­¥æ•°
    cfg_scale: float = 7.0   # CFGå¼•å¯¼ç³»æ•°
    sampler_name: str = None # é‡‡æ ·å™¨
    seed: int = -1           # éšæœºç§å­
```

**å…³é”®å‡½æ•°**:

1. **txt2img_image_conditioning()** - åˆ›å»ºæ–‡ç”Ÿå›¾æ¡ä»¶ç¼–ç 
   - åŠŸèƒ½ï¼šä¸ºä¸åŒç±»å‹æ¨¡å‹ï¼ˆInpaintingã€UnCLIPã€SDXLï¼‰åˆ›å»ºé€‚å½“çš„æ¡ä»¶å¼ é‡
   - å‚æ•°ï¼šsd_model, xï¼ˆæ½œåœ¨å¼ é‡ï¼‰, width, height
   - è¿”å›ï¼šæ¡ä»¶å¼ é‡

2. **create_binary_mask()** - åˆ›å»ºäºŒå€¼é®ç½©
   - åŠŸèƒ½ï¼šä»RGBAå›¾åƒçš„alphaé€šé“åˆ›å»ºé»‘ç™½é®ç½©
   - å‚æ•°ï¼šimageï¼ˆPILå›¾åƒï¼‰, roundï¼ˆæ˜¯å¦å››èˆäº”å…¥ï¼‰

3. **apply_color_correction()** - åº”ç”¨é¢œè‰²æ ¡æ­£
   - åŠŸèƒ½ï¼šä½¿ç”¨ç›´æ–¹å›¾åŒ¹é…ä¿æŒé¢œè‰²ä¸€è‡´æ€§

**å¤„ç†æµç¨‹**:
```
åˆå§‹åŒ–å‚æ•° â†’ è®¾ç½®ç§å­ â†’ å¤„ç†æç¤ºè¯ â†’ æ¡ä»¶ç¼–ç  â†’ é‡‡æ · â†’ è§£ç  â†’ åå¤„ç† â†’ ä¿å­˜
```

---

## 4. æ¨¡å‹ç®¡ç†

### 4.1 sd_models.py
**è·¯å¾„**: `modules/sd_models.py`

**åŠŸèƒ½**: ç®¡ç†Stable Diffusionæ¨¡å‹çš„åŠ è½½ã€å¸è½½å’Œå…ƒæ•°æ®

**æ¨¡å‹ç±»å‹**:
```python
class ModelType(enum.Enum):
    SD1 = 1   # Stable Diffusion 1.x
    SD2 = 2   # Stable Diffusion 2.x
    SDXL = 3  # Stable Diffusion XL
    SSD = 4   # Small SD
    SD3 = 5   # Stable Diffusion 3
```

**æ ¸å¿ƒç±»**: `CheckpointInfo`

```python
class CheckpointInfo:
    filename: str    # æ¨¡å‹æ–‡ä»¶è·¯å¾„
    name: str        # æ¨¡å‹åç§°
    hash: str        # å¿«é€Ÿå“ˆå¸Œï¼ˆå‰8ä½ï¼‰
    sha256: str      # å®Œæ•´SHA256å“ˆå¸Œ
    shorthash: str   # çŸ­å“ˆå¸Œï¼ˆå‰10ä½ï¼‰
    title: str       # æ˜¾ç¤ºæ ‡é¢˜
    metadata: dict   # å…ƒæ•°æ®ï¼ˆsafetensorsï¼‰
```

**å…³é”®å‡½æ•°**:

1. **list_models()** - æ‰«æå¹¶åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ¨¡å‹
   - æ‰«æç›®å½•ï¼š`models/Stable-diffusion/`
   - æ”¯æŒæ ¼å¼ï¼š`.ckpt`, `.safetensors`
   - æ’é™¤æ–‡ä»¶ï¼š`.vae.ckpt`, `.vae.safetensors`

2. **get_closet_checkpoint_match()** - æ¨¡ç³ŠåŒ¹é…æ¨¡å‹
   - æ”¯æŒæŒ‰åç§°ã€æ ‡é¢˜ã€å“ˆå¸Œå€¼æœç´¢
   - è¿”å›æœ€ä½³åŒ¹é…çš„CheckpointInfoå¯¹è±¡

**å…¨å±€å˜é‡**:
- `checkpoints_list`: æ‰€æœ‰æ£€æŸ¥ç‚¹å­—å…¸ `{title: CheckpointInfo}`
- `checkpoint_aliases`: åˆ«åæ˜ å°„ `{id: CheckpointInfo}`

---

## 5. é‡‡æ ·å™¨ç®¡ç†

### 5.1 sd_samplers.py
**è·¯å¾„**: `modules/sd_samplers.py`

**åŠŸèƒ½**: ç®¡ç†æ‰€æœ‰é‡‡æ ·å™¨ï¼Œå¤„ç†é‡‡æ ·å™¨ä¸è°ƒåº¦å™¨çš„é…å¯¹

**é‡‡æ ·å™¨åˆ†ç±»**:
```python
all_samplers = [
    *sd_samplers_kdiffusion.samplers_data_k_diffusion,  # Euler, DPM++ç­‰
    *sd_samplers_timesteps.samplers_data_timesteps,     # DDIM, PLMSç­‰
    *sd_samplers_lcm.samplers_data_lcm,                 # LCMé‡‡æ ·å™¨
]
```

**å…³é”®å‡½æ•°**:

1. **create_sampler(name, model)** - åˆ›å»ºé‡‡æ ·å™¨å®ä¾‹
   - æŸ¥æ‰¾é…ç½®
   - æ£€æŸ¥SDXLå…¼å®¹æ€§
   - å®ä¾‹åŒ–é‡‡æ ·å™¨

2. **get_sampler_and_scheduler()** - è·å–é‡‡æ ·å™¨å’Œè°ƒåº¦å™¨é…å¯¹
   - è§£æç»„åˆåç§°ï¼ˆå¦‚"Euler a Karras"ï¼‰
   - è¿”å›ï¼š(é‡‡æ ·å™¨åç§°, è°ƒåº¦å™¨æ ‡ç­¾)

**å¸¸è§é‡‡æ ·å™¨**:
- Euler, Euler a
- DPM++ 2M, DPM++ 2M Karras
- DPM++ SDE, DPM++ SDE Karras
- DDIM, PLMS
- UniPC, LCM

---

## 6. APIæ¥å£

### 6.1 api/api.py
**è·¯å¾„**: `modules/api/api.py`

**åŠŸèƒ½**: æä¾›RESTful APIæ¥å£ï¼Œæ”¯æŒç¨‹åºåŒ–è°ƒç”¨

**ä¸»è¦ç«¯ç‚¹**:

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/sdapi/v1/txt2img` | POST | æ–‡æœ¬ç”Ÿæˆå›¾åƒ |
| `/sdapi/v1/img2img` | POST | å›¾åƒç”Ÿæˆå›¾åƒ |
| `/sdapi/v1/extra-single-image` | POST | å•å›¾åƒå¢å¼º |
| `/sdapi/v1/interrogate` | POST | åæ¨æç¤ºè¯ |
| `/sdapi/v1/models` | GET | è·å–æ¨¡å‹åˆ—è¡¨ |
| `/sdapi/v1/samplers` | GET | è·å–é‡‡æ ·å™¨åˆ—è¡¨ |
| `/sdapi/v1/options` | GET/POST | è·å–/è®¾ç½®é€‰é¡¹ |

**æ ¸å¿ƒå‡½æ•°**:

1. **decode_base64_to_image()** - è§£ç Base64å›¾åƒ
   - æ”¯æŒï¼šBase64ç¼–ç ã€HTTP(S) URLã€data URI
   - å®‰å…¨æ€§ï¼šæœ¬åœ°è¯·æ±‚é™åˆ¶ã€SSRFé˜²æŠ¤

2. **encode_pil_to_base64()** - ç¼–ç å›¾åƒä¸ºBase64
   - æ”¯æŒæ ¼å¼ï¼šPNGã€JPEGã€WebP
   - ä¿ç•™å…ƒæ•°æ®å’ŒEXIFä¿¡æ¯

3. **api_middleware()** - APIä¸­é—´ä»¶
   - è¯·æ±‚æ—¥å¿—è®°å½•
   - æ€§èƒ½è®¡æ—¶
   - ç»Ÿä¸€å¼‚å¸¸å¤„ç†

**å®‰å…¨ç‰¹æ€§**:
- HTTP Basic Authentication
- æœ¬åœ°è¯·æ±‚ä¿æŠ¤ï¼ˆé˜²SSRFï¼‰
- è¯·æ±‚å‚æ•°éªŒè¯
- CORSé…ç½®

---

## 7. ç”¨æˆ·ç•Œé¢

### 7.1 ui.py
**è·¯å¾„**: `modules/ui.py`

**åŠŸèƒ½**: åˆ›å»ºGradio Webç•Œé¢ï¼Œå¤„ç†ç”¨æˆ·äº¤äº’

**UIç»“æ„**:
```
ä¸»ç•Œé¢ (gr.Blocks)
â”œâ”€â”€ txt2img - æ–‡ç”Ÿå›¾
â”‚   â”œâ”€â”€ æç¤ºè¯è¾“å…¥ï¼ˆæ­£å‘/è´Ÿå‘ï¼‰
â”‚   â”œâ”€â”€ ç”Ÿæˆå‚æ•°ï¼ˆå°ºå¯¸ã€æ­¥æ•°ã€CFGç­‰ï¼‰
â”‚   â”œâ”€â”€ é«˜åˆ†è¾¨ç‡ä¿®å¤
â”‚   â””â”€â”€ è„šæœ¬é¢æ¿
â”œâ”€â”€ img2img - å›¾ç”Ÿå›¾
â”‚   â”œâ”€â”€ å›¾åƒè¾“å…¥ï¼ˆå¤šç§æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ Inpaintè®¾ç½®
â”‚   â””â”€â”€ æ‰¹å¤„ç†
â”œâ”€â”€ Extras - å›¾åƒå¢å¼º
â”œâ”€â”€ PNG Info - å…ƒæ•°æ®æŸ¥çœ‹
â”œâ”€â”€ Checkpoint Merger - æ¨¡å‹åˆå¹¶
â””â”€â”€ Settings - è®¾ç½®
```

**å…³é”®å‡½æ•°**:

1. **update_token_counter()** - æ›´æ–°Tokenè®¡æ•°
   - è§£ææç¤ºè¯ï¼Œåº”ç”¨æ ·å¼
   - è®¡ç®—tokenæ•°é‡
   - æ˜¾ç¤ºï¼štoken/æœ€å¤§é•¿åº¦

2. **interrogate()** - CLIPåæ¨æç¤ºè¯
   - ä½¿ç”¨CLIPæ¨¡å‹åˆ†æå›¾åƒ
   - ç”Ÿæˆæè¿°æ€§æç¤ºè¯

3. **interrogate_deepbooru()** - DeepBooruåæ¨æ ‡ç­¾
   - ç”¨äºåŠ¨æ¼«å›¾åƒ
   - ç”Ÿæˆæ ‡ç­¾åˆ—è¡¨

**ç‰¹æ®Šç¬¦å·**:
- ğŸ² éšæœºç§å­
- â™»ï¸ é‡ç”¨ç§å­
- ğŸ”„ åˆ·æ–°
- ğŸ’¾ ä¿å­˜æ ·å¼
- ğŸ—‘ï¸ æ¸…é™¤

---

## 8. è„šæœ¬ç³»ç»Ÿ

### 8.1 scripts.py
**è·¯å¾„**: `modules/scripts.py`

**åŠŸèƒ½**: æä¾›è„šæœ¬æ‰©å±•æœºåˆ¶ï¼Œå…è®¸ç”¨æˆ·è‡ªå®šä¹‰åŠŸèƒ½

**ScriptåŸºç±»**:
```python
class Script:
    name = None          # è„šæœ¬åç§°
    alwayson = False     # æ˜¯å¦å§‹ç»ˆå¯ç”¨
    
    def title(self):
        """è¿”å›è„šæœ¬æ ‡é¢˜"""
        raise NotImplementedError()
    
    def ui(self, is_img2img):
        """åˆ›å»ºUIç»„ä»¶ï¼Œè¿”å›ç»„ä»¶åˆ—è¡¨"""
        pass
    
    def run(self, p, *args):
        """æ‰§è¡Œè„šæœ¬é€»è¾‘"""
        pass
```

**ç”Ÿå‘½å‘¨æœŸå›è°ƒ**:

| å›è°ƒæ–¹æ³• | è°ƒç”¨æ—¶æœº | ç”¨é€” |
|----------|----------|------|
| `setup()` | å¤„ç†å¯¹è±¡è®¾ç½®å | åˆå§‹åŒ–è„šæœ¬çŠ¶æ€ |
| `before_process()` | å¤„ç†å¼€å§‹å‰ | ä¿®æ”¹å¤„ç†å‚æ•° |
| `process()` | å¤„ç†å¼€å§‹æ—¶ | æ³¨å…¥é’©å­ |
| `before_process_batch()` | æ‰¹æ¬¡å¤„ç†å‰ | ä¿®æ”¹æç¤ºè¯ |
| `process_batch()` | æ‰¹æ¬¡å¤„ç†ä¸­ | æ‰¹æ¬¡çº§åˆ«å¤„ç† |
| `postprocess_image()` | å•å›¾ç”Ÿæˆå | å›¾åƒçº§åˆ«åå¤„ç† |
| `postprocess()` | å…¨éƒ¨å®Œæˆå | æœ€ç»ˆå¤„ç† |

**å†…ç½®è„šæœ¬ç¤ºä¾‹**:
- X/Y/Z plotï¼šå‚æ•°ç½‘æ ¼æœç´¢
- Prompt matrixï¼šæç¤ºè¯çŸ©é˜µ
- Loopbackï¼šå¾ªç¯åé¦ˆç”Ÿæˆ
- Outpaintingï¼šå¤–ç»˜åˆ¶æ‰©å±•

---

## 9. æ–‡ç”Ÿå›¾ä¸å›¾ç”Ÿå›¾

### 9.1 txt2img.py
**è·¯å¾„**: `modules/txt2img.py`

**åŠŸèƒ½**: æ–‡æœ¬ç”Ÿæˆå›¾åƒ

**æ ¸å¿ƒå‡½æ•°**:
```python
def txt2img(id_task, request, *args):
    # åˆ›å»ºå¤„ç†å¯¹è±¡
    p = txt2img_create_processing(id_task, request, *args)
    
    # æ‰§è¡Œè„šæœ¬
    processed = modules.scripts.scripts_txt2img.run(p, *p.script_args)
    
    # å¤„ç†å›¾åƒ
    if processed is None:
        processed = processing.process_images(p)
    
    return processed.images, generation_info_js, ...
```

**æ”¯æŒåŠŸèƒ½**:
- åŸºç¡€æ–‡ç”Ÿå›¾
- é«˜åˆ†è¾¨ç‡ä¿®å¤ï¼ˆHires fixï¼‰
- æ‰¹é‡ç”Ÿæˆ
- æ ·å¼åº”ç”¨

---

### 9.2 img2img.py
**è·¯å¾„**: `modules/img2img.py`

**åŠŸèƒ½**: å›¾åƒç”Ÿæˆå›¾åƒ

**æ”¯æŒæ¨¡å¼**:

| æ¨¡å¼ | è¯´æ˜ |
|------|------|
| mode 0 | img2imgï¼ˆåŸºç¡€ï¼‰ |
| mode 1 | sketchï¼ˆè‰å›¾ï¼‰ |
| mode 2 | inpaintï¼ˆä¿®å¤ï¼‰ |
| mode 3 | inpaint sketchï¼ˆä¿®å¤è‰å›¾ï¼‰ |
| mode 4 | inpaint uploadï¼ˆä¸Šä¼ é®ç½©ï¼‰ |
| mode 5 | batchï¼ˆæ‰¹å¤„ç†ï¼‰ |

**æ ¸å¿ƒå‡½æ•°**:
```python
def img2img(id_task, request, mode, *args):
    # æ ¹æ®æ¨¡å¼è·å–å›¾åƒå’Œé®ç½©
    if mode == 0:
        image = init_img
        mask = None
    elif mode == 2:
        image, mask = init_img_with_mask["image"], init_img_with_mask["mask"]
    
    # åˆ›å»ºå¤„ç†å¯¹è±¡
    p = StableDiffusionProcessingImg2Img(...)
    
    # å¤„ç†
    processed = process_images(p)
    return processed.images, ...
```

**æ‰¹å¤„ç†åŠŸèƒ½**:
- æ‰¹é‡å¤„ç†å¤šä¸ªå›¾åƒ
- æ”¯æŒç›®å½•è¾“å…¥
- å¯é€‰é®ç½©ç›®å½•
- PNGå…ƒæ•°æ®è¯»å–

---

## 10. å…±äº«é…ç½®

### 10.1 shared.py
**è·¯å¾„**: `modules/shared.py`

**åŠŸèƒ½**: å…¨å±€å…±äº«å˜é‡å’Œé…ç½®

**ä¸»è¦å˜é‡**:

| å˜é‡å | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `cmd_opts` | object | å‘½ä»¤è¡Œå‚æ•° |
| `demo` | gr.Blocks | Gradioåº”ç”¨å®ä¾‹ |
| `device` | str | è®¡ç®—è®¾å¤‡ï¼ˆcuda/cpuï¼‰ |
| `sd_model` | object | å½“å‰SDæ¨¡å‹ |
| `opts` | Options | ç”¨æˆ·é€‰é¡¹ |
| `state` | State | åº”ç”¨çŠ¶æ€ |
| `prompt_styles` | StyleDatabase | æç¤ºè¯æ ·å¼ |
| `interrogator` | object | åæ¨æ¨¡å‹ |

**é…ç½®ç®¡ç†**:
- ä»`config.json`åŠ è½½é…ç½®
- æ”¯æŒè¿è¡Œæ—¶ä¿®æ”¹
- è‡ªåŠ¨ä¿å­˜å˜æ›´

---

## é™„å½•ï¼šæ¨¡å—å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  launch.py  â”‚ â† å…¥å£
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  webui.py   â”‚ â† ä¸»æ§åˆ¶å™¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”œâ”€â”€â”€â”€â”€â†’ initialize.py (åˆå§‹åŒ–)
       â”œâ”€â”€â”€â”€â”€â†’ ui.py (ç•Œé¢)
       â””â”€â”€â”€â”€â”€â†’ api.py (API)
              â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ processing.pyâ”‚ â† æ ¸å¿ƒå¤„ç†
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â”œâ”€â”€â”€â”€â”€â†’ txt2img.py
              â”œâ”€â”€â”€â”€â”€â†’ img2img.py
              â”œâ”€â”€â”€â”€â”€â†’ sd_models.py (æ¨¡å‹)
              â”œâ”€â”€â”€â”€â”€â†’ sd_samplers.py (é‡‡æ ·å™¨)
              â””â”€â”€â”€â”€â”€â†’ scripts.py (è„šæœ¬)
                     â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  shared.py   â”‚ â† å…¨å±€é…ç½®
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. å›¾åƒç”Ÿæˆæµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ æç¤ºè¯ç¼–ç  â†’ å™ªå£°åˆå§‹åŒ– â†’ è¿­ä»£å»å™ª â†’ è§£ç  â†’ åå¤„ç† â†’ è¾“å‡º
```

### 2. å†…å­˜ä¼˜åŒ–ç­–ç•¥
- **ä½æ˜¾å­˜æ¨¡å¼** (`--lowvram`)ï¼šæ¨¡å‹åˆ†å—åŠ è½½åˆ°VRAM
- **ä¸­ç­‰æ˜¾å­˜æ¨¡å¼** (`--medvram`)ï¼šéƒ¨åˆ†æ¨¡å‹ä¿ç•™åœ¨VRAM
- **Tokenåˆå¹¶** (`tomesd`)ï¼šå‡å°‘è®¡ç®—é‡
- **æ³¨æ„åŠ›ä¼˜åŒ–** (`xFormers`)ï¼šé«˜æ•ˆattentionå®ç°

### 3. æ‰©å±•æœºåˆ¶
- **è„šæœ¬ç³»ç»Ÿ**ï¼šé€šè¿‡Scriptç±»æ‰©å±•åŠŸèƒ½
- **å›è°ƒé’©å­**ï¼šscript_callbacksæä¾›å¤šä¸ªæ‰©å±•ç‚¹
- **Extensionç³»ç»Ÿ**ï¼šç‹¬ç«‹çš„æ‰©å±•ç›®å½•

### 4. æ€§èƒ½ä¼˜åŒ–
- **æ‰¹å¤„ç†**ï¼šåŒæ—¶ç”Ÿæˆå¤šå¼ å›¾åƒ
- **CUDAä¼˜åŒ–**ï¼šå……åˆ†åˆ©ç”¨GPUå¹¶è¡Œè®¡ç®—
- **ç¼“å­˜æœºåˆ¶**ï¼šæ¨¡å‹å’Œæç¤ºè¯ç¼–ç ç¼“å­˜
- **å¼‚æ­¥å¤„ç†**ï¼šUIå’Œç”Ÿæˆåˆ†ç¦»

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½
1. **é€šè¿‡è„šæœ¬**ï¼šåœ¨`scripts/`ç›®å½•åˆ›å»ºæ–°è„šæœ¬
2. **ä¿®æ”¹UI**ï¼šç¼–è¾‘`modules/ui.py`
3. **æ·»åŠ API**ï¼šåœ¨`modules/api/api.py`æ·»åŠ ç«¯ç‚¹
4. **è‡ªå®šä¹‰é‡‡æ ·å™¨**ï¼šæ‰©å±•`sd_samplers_*`æ¨¡å—

### è°ƒè¯•æŠ€å·§
- ä½¿ç”¨`--debug`å‚æ•°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- æ£€æŸ¥æ§åˆ¶å°è¾“å‡º
- ä½¿ç”¨Pythonè°ƒè¯•å™¨ï¼ˆpdbï¼‰
- æŸ¥çœ‹ç”Ÿæˆå›¾åƒçš„å…ƒæ•°æ®ï¼ˆPNG Infoï¼‰

### å¸¸ç”¨å‘½ä»¤è¡Œå‚æ•°
```bash
# ä½æ˜¾å­˜æ¨¡å¼
--lowvram

# æŒ‡å®šç«¯å£
--port 7860

# å¯ç”¨API
--api

# ä»…APIæ¨¡å¼
--nowebui

# å…±äº«æœåŠ¡
--share

# è·³è¿‡ç‰ˆæœ¬æ£€æŸ¥
--skip-version-check
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç”Ÿæˆæ—¶é—´**: 2024å¹´  
**é¡¹ç›®**: Stable Diffusion WebUI  
**è¯´æ˜**: æœ¬æ–‡æ¡£æ¶µç›–äº†é¡¹ç›®çš„æ ¸å¿ƒæ¨¡å—å’Œå…³é”®ä»£ç ï¼Œè¯¦ç»†è·¯å¾„æ ‡æ³¨ä¾¿äºå®šä½æºç 
